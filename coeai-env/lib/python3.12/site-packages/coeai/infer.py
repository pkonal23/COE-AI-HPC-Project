import requests
import base64
import os

class LLMinfer:
    def __init__(self, api_url="http://localhost:8000/generate", api_key="mysecretkey"):
        self.api_url = api_url
        self.api_key = api_key
        self.headers = {
            "Content-Type": "application/json",
            "X-API-Key": self.api_key
        }

    def infer(self, mode, prompt_text, image_path=None):
        if mode == "text-to-text":
            payload = {
                "model": "llama4",
                "messages": [
                    {
                        "role": "system",
                        "content": "This is a chat between a user and an assistant. The assistant is helping the user with general questions."
                    },
                    {
                        "role": "user",
                        "content": prompt_text
                    }
                ],
                "stream": False
            }

        elif mode == "image-text-to-text":
            if not image_path or not os.path.exists(image_path):
                raise FileNotFoundError("Image path must be provided and valid for image-text-to-text mode.")

            with open(image_path, "rb") as f:
                base64_image = base64.b64encode(f.read()).decode("utf-8")

            payload = {
                "model": "llama4",
                "messages": [
                    {
                        "role": "system",
                        "content": "This is a chat between a user and an assistant. The assistant is helping the user to describe an image."
                    },
                    {
                        "role": "user",
                        "content": [
                            {
                                "type": "image_url",
                                "image_url": {
                                    "url": f"data:image/jpeg;base64,{base64_image}"
                                }
                            },
                            {
                                "type": "text",
                                "text": prompt_text
                            }
                        ]
                    }
                ],
                "stream": False
            }

        else:
            raise ValueError("Invalid mode. Use 'text-to-text' or 'image-text-to-text'.")

        response = requests.post(self.api_url, headers=self.headers, json=payload)
        return response.json()
